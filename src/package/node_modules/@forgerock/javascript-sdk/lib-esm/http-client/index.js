import e from"../config/index.js";import{ActionTypes as t}from"../config/enums.js";import r from"../event/index.js";import n from"../fr-auth/index.js";import{StepType as o}from"../fr-auth/enums.js";import i from"../fr-auth/fr-step.js";import s from"../token-manager/index.js";import a from"../token-storage/index.js";import{withTimeout as u}from"../util/timeout.js";import{addAuthzInfoToHeaders as c,hasAuthzAdvice as l,isAuthzStep as f,normalizeRESTJSON as h,examineForRESTAuthz as p,examineForIGAuthz as d,normalizeIGJSON as m,newTokenRequired as v,addAuthzInfoToURL as y,buildAuthzOptions as w}from"./helpers.js";import b from"../util/middleware.js";var g,j=(g=function(e,t){return g=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},g(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}g(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),x=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{u(n.next(e))}catch(e){i(e)}}function a(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))},_=function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},k=function(r){function g(){return null!==r&&r.apply(this,arguments)||this}return j(g,r),g.request=function(r){return x(this,void 0,void 0,(function(){var n,o,i,s,u,g,j,x,k,S,T,A,q,P,E,z,I;return _(this,(function(_){switch(_.label){case 0:return[4,this._request(r,!1)];case 1:return n=_.sent(),i=!1,v(n,r.requiresNewToken)?[4,this._request(r,!0)]:[3,3];case 2:n=_.sent(),_.label=3;case 3:return r.authorization&&r.authorization.handleStep?n.redirected&&d(n)?(i=!0,o=m(n),[3,7]):[3,4]:[3,16];case 4:return[4,p(n)];case 5:return _.sent()?[4,h(n)]:[3,7];case 6:o=_.sent(),_.label=7;case 7:return o&&o.advices?(s=e.get(r.authorization.config),u=s.middleware,g=s.realmPath,j=s.serverConfig,x=w(o,j.baseUrl,r.timeout,g,j.paths),k=new URL(x.url),S=k.searchParams.get("authIndexType"),T=k.searchParams.get("authIndexValue"),A=b({url:new URL(x.url),init:x.init},{type:t.StartAuthenticate,payload:{type:S,tree:T}}),q=A(u),P=q.url,E=q.init,x.url=P.toString(),x.init=E,[4,this._request(x,!1)]):[3,16];case 8:return z=_.sent(),[4,f(z)];case 9:if(!_.sent())throw new Error('Error: Initial response from auth server not a "step".');if(!l(o))throw new Error("Error: Transactional or Service Advice is empty.");return[4,this.stepIterator(z,r.authorization.handleStep,S,T)];case 10:_.sent(),I=void 0,_.label=11;case 11:return _.trys.push([11,13,,14]),[4,a.get()];case 12:return I=_.sent(),[3,14];case 13:return _.sent(),[3,14];case 14:return i?r.url=y(r.url,o.advices,I):r.init.headers=c(r.init,o.advices,I),[4,this._request(r,!1)];case 15:n=_.sent(),_.label=16;case 16:return[2,n]}}))}))},g.setAuthHeaders=function(e,t){return x(this,void 0,void 0,(function(){var r;return _(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,a.get()];case 1:return r=n.sent(),[3,3];case 2:return n.sent(),[3,3];case 3:return r&&r.accessToken?[4,s.getTokens({forceRenew:t})]:[3,5];case 4:(r=n.sent())&&r.accessToken&&e.set("Authorization","Bearer ".concat(r.accessToken)),n.label=5;case 5:return[2,e]}}))}))},g.stepIterator=function(e,t,r,s){return x(this,void 0,void 0,(function(){var a,u,c=this;return _(this,(function(l){switch(l.label){case 0:return[4,e.json()];case 1:return a=l.sent(),u=new i(a),[2,new Promise((function(e,i){return x(c,void 0,void 0,(function(){function a(u){return x(this,void 0,void 0,(function(){var c,l;return _(this,(function(f){switch(f.label){case 0:return[4,t(u)];case 1:return c=f.sent(),[4,n.next(c,{type:r,tree:s})];case 2:return(l=f.sent()).type===o.LoginSuccess?e():l.type===o.LoginFailure?i("Authentication tree failure."):a(l),[2]}}))}))}return _(this,(function(e){return a(u),[2]}))}))}))]}}))}))},g._request=function(e,t){return x(this,void 0,void 0,(function(){var r,n,o,i;return _(this,(function(s){switch(s.label){case 0:return r=e.url,n=e.init,o=e.timeout,i=new Headers(n.headers||{}),e.bypassAuthentication?[3,2]:[4,this.setAuthHeaders(i,t)];case 1:i=s.sent(),s.label=2;case 2:return n.headers=i,[2,u(fetch(r,n),o)]}}))}))},g}(r);export{k as default};