import{ActionTypes as e}from"../config/enums.js";import t from"../config/index.js";import r from"../token-storage/index.js";import{isOkOr4xx as n}from"../util/http.js";import o from"../util/pkce.js";import{withTimeout as i}from"../util/timeout.js";import{stringify as s,getEndpointPath as c,resolve as a}from"../util/url.js";export{ResponseType}from"./enums.js";import u from"../util/middleware.js";var d=function(){return d=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},d.apply(this,arguments)},l=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,c)}a((n=n.apply(e,t||[])).next())}))},f=function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}},h={AuthenticationConsentRequired:"Authentication or consent required",AuthorizationTimeout:"Authorization timed out",FailedToFetch:"Failed to fetch",NetworkError:"NetworkError when attempting to fetch resource.",CORSError:"Cross-origin redirection"},p=function(){function p(){}return p.createAuthorizeUrl=function(r){return l(this,void 0,void 0,(function(){var n,i,s,c,a,l,h,p;return f(this,(function(f){switch(f.label){case 0:return n=t.get(r),i=n.clientId,s=n.middleware,c=n.redirectUri,a=n.scope,l=d(d({},r.query),{client_id:i,redirect_uri:c,response_type:r.responseType,scope:a,state:r.state}),r.verifier?[4,o.createChallenge(r.verifier)]:[3,2];case 1:h=f.sent(),l.code_challenge=h,l.code_challenge_method="S256",f.label=2;case 2:return p=u({url:new URL(this.getUrl("authorize",l,r)),init:{}},{type:e.Authorize}),[2,p(s).url.toString()]}}))}))},p.getAuthCodeByIframe=function(e){return l(this,void 0,void 0,(function(){var r,n,o=this;return f(this,(function(i){switch(i.label){case 0:return[4,this.createAuthorizeUrl(e)];case 1:return r=i.sent(),n=t.get(e).serverConfig,[2,new Promise((function(e,t){var i,s=document.createElement("iframe"),c=function(){},a=c,u=0;i=function(){window.clearTimeout(u),s.removeEventListener("load",a),s.remove()},a=function(){if(s.contentWindow){var t=s.contentWindow.location.href;(o.containsAuthCode(t)||o.containsAuthError(t))&&(i(),e(t))}},u=window.setTimeout((function(){i(),t(new Error(h.AuthorizationTimeout))}),n.timeout),s.style.display="none",s.addEventListener("load",a),document.body.appendChild(s),s.src=r}))]}}))}))},p.getOAuth2Tokens=function(e){return l(this,void 0,void 0,(function(){var r,n,o,i,c,a,u,d,l,h,p;return f(this,(function(f){switch(f.label){case 0:return r=t.get(e),n=r.clientId,o=r.redirectUri,i={client_id:n,code:e.authorizationCode,grant_type:"authorization_code",redirect_uri:o},e.verifier&&(i.code_verifier=e.verifier),c=s(i),a={body:c,headers:new Headers({"Content-Length":c.length.toString(),"Content-Type":"application/x-www-form-urlencoded"}),method:"POST"},[4,this.request("accessToken",void 0,!1,a,e)];case 1:return u=f.sent(),[4,this.getBody(u)];case 2:if(d=f.sent(),200!==u.status)throw l="string"==typeof d?"Expected 200, received ".concat(u.status):this.parseError(d),new Error(l);if(!(h=d).access_token)throw new Error("Access token not found in response");return p=void 0,h.expires_in&&(p=Date.now()+1e3*h.expires_in),[2,{accessToken:h.access_token,idToken:h.id_token,refreshToken:h.refresh_token,tokenExpiry:p}]}}))}))},p.getUserInfo=function(e){return l(this,void 0,void 0,(function(){var t;return f(this,(function(r){switch(r.label){case 0:return[4,this.request("userInfo",void 0,!0,void 0,e)];case 1:if(200!==(t=r.sent()).status)throw new Error("Failed to get user info; received ".concat(t.status));return[4,t.json()];case 2:return[2,r.sent()]}}))}))},p.endSession=function(e){return l(this,void 0,void 0,(function(){var t,o,i;return f(this,(function(s){switch(s.label){case 0:return[4,r.get()];case 1:return t=s.sent().idToken,o={},t&&(o.id_token_hint=t),[4,this.request("endSession",o,!0,void 0,e)];case 2:if(i=s.sent(),!n(i))throw new Error("Failed to end session; received ".concat(i.status));return[2,i]}}))}))},p.revokeToken=function(e){return l(this,void 0,void 0,(function(){var o,i,c,a;return f(this,(function(u){switch(u.label){case 0:return o=t.get(e).clientId,[4,r.get()];case 1:return i=u.sent().accessToken,c={body:s({client_id:o,token:i}),credentials:"include",headers:new Headers({"Content-Type":"application/x-www-form-urlencoded"}),method:"POST"},[4,this.request("revoke",void 0,!1,c,e)];case 2:if(a=u.sent(),!n(a))throw new Error("Failed to revoke token; received ".concat(a.status));return[2,a]}}))}))},p.request=function(n,o,s,c,a){return l(this,void 0,void 0,(function(){var d,l,h,p,v,w,m,g;return f(this,(function(f){switch(f.label){case 0:return d=t.get(a),l=d.middleware,h=d.serverConfig,p=this.getUrl(n,o,a),v=function(t){switch(t){case"accessToken":return e.ExchangeToken;case"endSession":return e.EndSession;case"revoke":return e.RevokeToken;default:return e.UserInfo}},c=c||{},s?[4,r.get()]:[3,2];case 1:w=f.sent().accessToken,c.credentials="include",c.headers=c.headers||new Headers,c.headers.set("Authorization","Bearer ".concat(w)),f.label=2;case 2:return m=u({url:new URL(p),init:c},{type:v(n)}),g=m(l),[4,i(fetch(g.url.toString(),g.init),h.timeout)];case 3:return[2,f.sent()]}}))}))},p.containsAuthCode=function(e){return!!e&&/code=([^&]+)/.test(e)},p.containsAuthError=function(e){return!!e&&/error=([^&]+)/.test(e)},p.getBody=function(e){return l(this,void 0,void 0,(function(){var t;return f(this,(function(r){switch(r.label){case 0:return(t=e.headers.get("Content-Type"))&&t.indexOf("application/json")>-1?[4,e.json()]:[3,2];case 1:case 3:return[2,r.sent()];case 2:return[4,e.text()]}}))}))},p.parseError=function(e){if(e){if(e.error&&e.error_description)return"".concat(e.error,": ").concat(e.error_description);if(e.code&&e.message)return"".concat(e.code,": ").concat(e.message)}},p.getUrl=function(e,r,n){var o=t.get(n),i=o.realmPath,u=o.serverConfig,d=c(e,i,u.paths),l=a(u.baseUrl,d);return r&&(l+="?".concat(s(r))),l},p}();export{h as allowedErrors,p as default};