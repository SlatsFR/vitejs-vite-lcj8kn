import e from"../config/index.js";import r from"../util/middleware.js";import t,{allowedErrors as n}from"../oauth2-client/index.js";import o from"../token-storage/index.js";import i from"../util/pkce.js";import{withTimeout as s}from"../util/timeout.js";import{parseQuery as a}from"../util/url.js";import{ActionTypes as u}from"../config/enums.js";import{tokensWillExpireWithinThreshold as c}from"./helpers.js";import{ResponseType as l}from"../oauth2-client/enums.js";var d=function(){return d=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e},d.apply(this,arguments)},f=function(e,r,t,n){return new(t||(t=Promise))((function(o,i){function s(e){try{u(n.next(e))}catch(e){i(e)}}function a(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,a)}u((n=n.apply(e,r||[])).next())}))},h=function(e,r){var t,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;s;)try{if(t=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=r.call(e,s)}catch(e){i=[6,e],n=0}finally{t=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},v=function(){function v(){}return v.getTokens=function(p){var m,w,y;return f(this,void 0,void 0,(function(){var f,g,b,k,x,E,j,q,S,T,A,R,C,O,z,U,I,P,F,L,N,J;return h(this,(function(h){switch(h.label){case 0:f=null,g=e.get(p),b=g.clientId,k=g.middleware,x=g.serverConfig,E=g.support,j=g.oauthThreshold,h.label=1;case 1:return h.trys.push([1,3,,4]),[4,o.get()];case 2:return f=h.sent(),[3,4];case 3:return q=h.sent(),console.info("No stored tokens available",q),[3,4];case 4:if(f&&!(null==p?void 0:p.forceRenew)&&!(null===(m=null==p?void 0:p.query)||void 0===m?void 0:m.code)&&!c(j,f.tokenExpiry))return[2,f];if(!f)return[3,9];h.label=5;case 5:return h.trys.push([5,8,,9]),[4,t.revokeToken(p)];case 6:return h.sent(),[4,v.deleteTokens()];case 7:return h.sent(),[3,9];case 8:return S=h.sent(),console.warn("Existing tokens could not be revoked or deleted",S),[3,9];case 9:return(null===(w=null==p?void 0:p.query)||void 0===w?void 0:w.code)&&(null===(y=null==p?void 0:p.query)||void 0===y?void 0:y.state)?(T=window.sessionStorage.getItem(b),window.sessionStorage.removeItem(b),A=JSON.parse(T),[4,this.tokenExchange(p,A)]):[3,11];case 10:return[2,h.sent()];case 11:return R=i.createVerifier(),C=i.createState(),O=d(d({},p),{responseType:l.Code,state:C,verifier:R}),[4,t.createAuthorizeUrl(O)];case 12:z=h.sent(),h.label=13;case 13:return h.trys.push([13,18,,19]),U=void 0,"legacy"!==E&&void 0!==E?[3,15]:(I=URL.bind,[4,t.getAuthCodeByIframe(O)]);case 14:return U=new(I.apply(URL,[void 0,h.sent()])),[3,17];case 15:return P=r({url:new URL(z),init:{credentials:"include",mode:"cors"}},{type:u.Authorize}),F=P(k).init,[4,s(fetch(z,F),x.timeout)];case 16:L=h.sent(),U=new URL(L.url),h.label=17;case 17:if(U.searchParams.get("error"))throw Error("".concat(U.searchParams.get("error_description")));if(!U.searchParams.get("code"))throw Error(n.AuthenticationConsentRequired);return N=a(U.toString()),p||(p={}),p.query=N,[3,19];case 18:if(!((J=h.sent())instanceof Error)||"redirect"!==(null==p?void 0:p.login))throw J;if(n.AuthenticationConsentRequired!==J.message&&n.AuthorizationTimeout!==J.message&&n.FailedToFetch!==J.message&&n.NetworkError!==J.message&&!J.message.includes(n.CORSError))throw J;return window.sessionStorage.setItem(b,JSON.stringify(O)),[2,window.location.assign(z)];case 19:return[4,this.tokenExchange(p,{state:C,verifier:R})];case 20:return[2,h.sent()]}}))}))},v.deleteTokens=function(){return f(this,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return[4,o.remove()];case 1:return e.sent(),[2]}}))}))},v.tokenExchange=function(e,r){var n,i,s,a;return f(this,void 0,void 0,(function(){var u,c,l,f,v;return h(this,(function(h){switch(h.label){case 0:if((null===(n=e.query)||void 0===n?void 0:n.state)!==r.state)throw new Error("State mismatch");if(!(null===(i=e.query)||void 0===i?void 0:i.code)||Array.isArray(null===(s=e.query)||void 0===s?void 0:s.code))throw new Error("Failed to acquire authorization code");return u=null===(a=e.query)||void 0===a?void 0:a.code,c=r.verifier,l=d(d({},e),{authorizationCode:u,verifier:c}),[4,t.getOAuth2Tokens(l)];case 1:if(!(f=h.sent())||!f.accessToken)throw new Error("Unable to exchange authorization for tokens");h.label=2;case 2:return h.trys.push([2,4,,5]),[4,o.set(f)];case 3:return h.sent(),[3,5];case 4:return v=h.sent(),console.error("Failed to store tokens",v),[3,5];case 5:return[2,f]}}))}))},v}();export{v as default};